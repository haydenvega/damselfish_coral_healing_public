---
title: "Coral Wound Healing Analysis: Effects of Damselfish Presence and Wound Size"
author: "Hayden Vega & Adrian Stier"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 7,
  dpi = 300
)
```

# Overview {.tabset}

## Study Design

**Research Question**: Do damselfish (*Dascyllus flavicaudus*) accelerate coral wound healing rates in *Pocillopora* spp.?

**Experimental Design**:

- **Factors**: Fish presence (Present/Absent) × Wound size (None/Small/Large)
- **Sample size**: 72 coral fragments
- **Duration**: 21 days
- **Location**: Mo'orea, French Polynesia
- **Response variables**:
  - Healing rate (cm²/day)
  - Percent wound closure
  - Binary healing outcome

## Analysis Overview

This document contains:

1. **Data Import & Cleaning**
2. **Exploratory Data Analysis**
3. **Mixed-Effects Models** (healing rate)
4. **Publication Figure Generation**
5. **Model Diagnostics**

---

# 1. Setup & Data Import

## Load Required Packages

```{r load-packages}
# ==================== Core Packages ====================
library(tidyverse)      # Data wrangling and visualization
library(here)           # Relative file paths
library(janitor)        # Data cleaning

# ==================== Statistical Modeling ====================
library(lme4)           # Linear mixed-effects models
library(glmmTMB)        # Generalized linear mixed models
library(DHARMa)         # Residual diagnostics for GLMMs
library(MuMIn)          # Model selection
library(parameters)     # Model parameter extraction
library(broom.mixed)    # Tidy model outputs
library(ggeffects)      # Marginal effects

# ==================== Visualization ====================
library(ggpubr)         # Publication-ready plots
library(viridis)        # Color palettes
library(patchwork)      # Combine plots
library(gt)             # Publication-quality tables

# ==================== Fonts ====================
library(sysfonts)       # Font management
library(showtext)       # Font rendering

# ==================== Optional: Advanced Models ====================
if (!requireNamespace("gamlss", quietly = TRUE)) {
  install.packages("gamlss")
}
library(gamlss)
library(gamlss.dist)

# Setup font rendering
font_add_google(name = "Josefin Sans", family = "josefin")
showtext_auto()

# Set default theme
theme_set(theme_bw() + theme(panel.grid = element_blank(), plot.background = element_blank()))
```

## Define Color Palettes

```{r define-aesthetics}
# Consistent color schemes for all figures
wound_palette <- c(
  "Large" = "#FF8B00",     # Orange
  "Small" = "#be8333",     # Tan
  "No Wound" = "#485900"   # Olive green
)

fish_palette <- c(
  "Fish" = "#2b4b52",      # Teal
  "No Fish" = "#ad301a"    # Burnt red
)
```

## Import Raw Data

```{r import-data}
# Import wound closure binary data (healed yes/no)
wound_closure <- read_csv(
  here("data", "fish_regen_mastersheet_wound closure_necrosis_sa - mastersheet.csv")
) %>%
  clean_names()

# Import quantitative healing rate data
percent_closure <- read_csv(
  here("data", "final_wound_size_dascyllus_project - Sheet1.csv")
) %>%
  clean_names()

cat("✓ Data imported successfully\n")
cat("  - Wound closure binary data:", nrow(wound_closure), "observations\n")
cat("  - Percent closure data:", nrow(percent_closure), "observations\n")
```

---

# 2. Data Preparation

## Treatment Coding Function

```{r prep-function}
#' Convert numeric treatment codes to labeled factors
#'
#' @param df Data frame containing fish and wound columns
#' @return Data frame with properly ordered factor levels
prep_treatments <- function(df) {
  df %>%
    mutate(
      # Convert fish coding: 1 = Fish present, 0 = Fish absent
      fish = ifelse(fish == 1, "Fish", ifelse(fish == 0, "No Fish", fish)),

      # Convert wound size coding: 0 = None, 1 = Small, 2 = Large
      wound = case_when(
        wound == 0 ~ "No Wound",
        wound == 1 ~ "Small",
        wound == 2 ~ "Large",
        TRUE ~ as.character(wound)
      )
    ) %>%
    mutate(
      # Set factor levels in logical order
      fish  = factor(fish, levels = c("No Fish", "Fish")),
      wound = factor(wound, levels = c("No Wound", "Small", "Large"))
    )
}
```

## Clean Wound Closure Data

```{r clean-wound-data}
# Process binary wound closure data
wound_closure_clean <- wound_closure %>%
  filter(!is.na(wound_close), wound_close != "") %>%
  # Standardize "barely healed" responses to "no"
  mutate(wound_close = ifelse(wound_close %in% c("no-barely", "no - barely"), "no", wound_close)) %>%
  mutate(wound_close = ifelse(wound_close == "yes", "Yes", "No")) %>%
  prep_treatments() %>%
  mutate(wound_close = as.character(wound_close))

# Create binary version for GLM modeling
wound_closure_glm <- wound_closure %>%
  filter(!is.na(wound_close), wound_close != "") %>%
  mutate(wound_bin = ifelse(wound_close == "yes", 1, 0)) %>%
  prep_treatments() %>%
  filter(!is.na(fish), !is.na(wound), !is.na(tank)) %>%
  droplevels()

# Quality check: Ensure factors have adequate levels
if (nlevels(wound_closure_glm$fish) < 2 | nlevels(wound_closure_glm$wound) < 2) {
  stop("ERROR: Fish or wound factors have <2 levels. Check input data.")
}

cat("✓ Data cleaning complete\n")
cat("  - Binary healing data:", nrow(wound_closure_clean), "corals\n")
```

## Clean Healing Rate Data

```{r clean-percent-data}
# Process continuous healing rate data
percent_closure <- percent_closure %>%
  filter(percent_healed >= 0) %>%  # Remove invalid percentages
  prep_treatments() %>%
  mutate(tank = as.factor(tank))

# Convert percent to proportion (0-1 scale)
percent_closure$prop <- percent_closure$percent_healed / 100
percent_closure$prop_remaining <- 1 - percent_closure$prop

cat("✓ Healing rate data prepared\n")
cat("  - Valid observations:", nrow(percent_closure), "corals\n")
cat("  - Mean healing rate:", round(mean(percent_closure$healing_rate, na.rm = TRUE), 3), "cm²/day\n")
```

## Data Summary

```{r data-summary}
# Cross-tabulation of treatments
cat("\n=== Treatment Sample Sizes ===\n")
print(table(percent_closure$fish, percent_closure$wound))

# Calculate healing proportions by treatment
wound_prop <- wound_closure_clean %>%
  group_by(wound, fish) %>%
  summarize(
    n = n(),
    prop_healed = mean(wound_close == "Yes"),
    .groups = "drop"
  )

cat("\n=== Proportion Healed by Treatment ===\n")
print(wound_prop)
```

---

# 3. Wound Size Characterization

```{r wound-sizes}
# Summarize initial wound sizes
wounds_avgs <- percent_closure %>%
  group_by(wound) %>%
  summarize(
    mean_size_cm2 = mean(initial_wound_size_cm, na.rm = TRUE),
    sd_size_cm2 = sd(initial_wound_size_cm, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) %>%
  filter(wound != "No Wound")

# Display as formatted table
wounds_avgs %>%
  gt() %>%
  tab_header(title = "Initial Wound Size by Treatment") %>%
  fmt_number(columns = c(mean_size_cm2, sd_size_cm2), decimals = 2) %>%
  cols_label(
    wound = "Wound Size",
    mean_size_cm2 = "Mean (cm²)",
    sd_size_cm2 = "SD (cm²)",
    n = "N"
  )
```

---

# 4. Statistical Models: Healing Rate

## Model Description

We fit linear mixed-effects models to test how fish presence and wound size affect healing rate (continuous response variable in cm²/day).

**Model structure**:
- **Fixed effects**: Fish presence, Wound size, and their interaction
- **Random effect**: Tank (accounts for shared tank environment)
- **Response**: Healing rate (cm²/day)

## Fit Candidate Models

```{r fit-healing-models}
# Full model with interaction
rate_full <- lmer(
  healing_rate ~ fish * wound + (1 | tank),
  data = percent_closure
)

# Additive model (no interaction)
rate_no_interaction <- lmer(
  healing_rate ~ fish + wound + (1 | tank),
  data = percent_closure
)

# Fish-only model
rate_no_fish <- lmer(
  healing_rate ~ wound + (1 | tank),
  data = percent_closure
)

# Wound-only model
rate_no_wound <- lmer(
  healing_rate ~ fish + (1 | tank),
  data = percent_closure
)

cat("✓ Models fitted successfully\n")
```

## Model Comparison: Likelihood Ratio Tests

```{r model-comparison}
# Test for interaction effect
lrt_interaction_zero_rate <- anova(rate_no_interaction, rate_full, test = "Chisq")

# Test for fish main effect
lrt_fish_zero_rate <- anova(rate_no_fish, rate_no_interaction, test = "Chisq")

# Test for wound main effect
lrt_wound_zero_rate <- anova(rate_no_wound, rate_no_interaction, test = "Chisq")

# Compile results into table
lrt_table_rate <- tibble(
  Test = c("Interaction (Fish × Wound)", "Fish Effect", "Wound Effect"),
  ChiSq = c(
    lrt_interaction_zero_rate$Chisq[2],
    lrt_fish_zero_rate$Chisq[2],
    lrt_wound_zero_rate$Chisq[2]
  ),
  Df = c(
    lrt_interaction_zero_rate$Df[2],
    lrt_fish_zero_rate$Df[2],
    lrt_wound_zero_rate$Df[2]
  ),
  p_value = c(
    lrt_interaction_zero_rate$`Pr(>Chisq)`[2],
    lrt_fish_zero_rate$`Pr(>Chisq)`[2],
    lrt_wound_zero_rate$`Pr(>Chisq)`[2]
  )
) %>%
  mutate(across(where(is.numeric), round, 3))

# Format as publication table
gt_table_rate <- lrt_table_rate %>%
  gt() %>%
  tab_header(
    title = "Likelihood Ratio Tests for Effects on Healing Rate"
  ) %>%
  cols_label(
    Test = "Model Comparison",
    ChiSq = "χ²",
    Df = "df",
    p_value = "P-value"
  ) %>%
  fmt_number(columns = c(ChiSq, p_value), decimals = 3) %>%
  tab_options(
    table.font.size = 14,
    heading.title.font.size = 16
  )

# Display table
print(gt_table_rate)

# Save table
gtsave(gt_table_rate, here("figures", "lrt_table_rate.html"))
```

## Model Summary

```{r model-summary}
# Display full model summary
summary(rate_full)

# Extract and display fixed effects
cat("\n=== Fixed Effects (Full Model) ===\n")
print(tidy(rate_full, effects = "fixed", conf.int = TRUE))
```

---

# 5. Publication Figure: Healing Rate

```{r pub-figure-healing, fig.width=8, fig.height=6}
# Create publication-quality figure
healing_plot <- percent_closure %>%
  ggplot(aes(x = wound, y = healing_rate, color = fish, shape = fish)) +

  # Individual data points (jittered and dodged)
  geom_jitter(
    aes(color = fish, shape = fish),
    position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.6),
    size = 2.5,
    alpha = 0.25,
    shape = 16
  ) +

  # Mean points
  stat_summary(
    fun = mean,
    geom = "point",
    size = 5,
    position = position_dodge(width = 0.6)
  ) +

  # Error bars (mean ± SD)
  stat_summary(
    fun.data = function(x) {
      data.frame(
        y = mean(x),
        ymin = mean(x) - sd(x),
        ymax = mean(x) + sd(x)
      )
    },
    geom = "errorbar",
    width = 0,
    size = 1,
    position = position_dodge(width = 0.6)
  ) +

  # Color and shape scales
  scale_color_manual(
    values = fish_palette,
    name = "Fish Presence",
    labels = c("No Fish", "Fish")
  ) +
  scale_shape_manual(
    values = c(16, 18),
    name = "Fish Presence",
    labels = c("No Fish", "Fish")
  )+
  scale_y_continuous(limits = c(0, 0.35)) +

  # Theme and aesthetics
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    axis.title = element_text(size = 20, face = "bold"),
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 16),
    legend.position = "top",
    legend.title = element_text(size = 18, face = "bold"),
    legend.text = element_text(size = 16),
    legend.key.size = unit(1.5, "lines"),
    legend.margin = margin(0, 0, 10, 0),
    legend.box.spacing = unit(0.5, "lines"),
    axis.line.x = element_line(color = "black", size = 0.5),
    axis.line.y = element_line(color = "black", size = 0.5)
  ) +
  labs(
    y = "Healing Rate (cm²/day)",
    x = "Wound Size"
  )

# Display plot
print(healing_plot)

# Save as PDF (vector, print-quality)
ggsave(
  filename = here("figures", "wound_closure", "summary_line_healing_rate_by_wound_fish.pdf"),
  plot = healing_plot,
  width = 7,
  height = 5,
  dpi = 600,
  device = cairo_pdf
)

# Save as PNG (raster, screen-quality)
ggsave(
  filename = here("figures", "wound_closure", "summary_line_healing_rate_by_wound_fish.png"),
  plot = healing_plot,
  width = 8,
  height = 6,
  dpi = 300,
  bg = "white"
)

cat("✓ Figure saved to figures/wound_closure/\n")
```

---

# 6. Summary Statistics by Treatment

```{r summary-stats}
# Wound size effect
rate_avg_wound <- percent_closure %>%
  group_by(wound) %>%
  summarize(
    mean_rate = mean(healing_rate, na.rm = TRUE),
    sd_rate = sd(healing_rate, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

cat("=== Healing Rate by Wound Size ===\n")
print(rate_avg_wound)

# Fish presence effect
rate_avg_fish <- percent_closure %>%
  group_by(fish) %>%
  summarize(
    mean_rate = mean(healing_rate, na.rm = TRUE),
    sd_rate = sd(healing_rate, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

cat("\n=== Healing Rate by Fish Presence ===\n")
print(rate_avg_fish)

# Interaction: Fish × Wound
rate_avg_interaction <- percent_closure %>%
  group_by(fish, wound) %>%
  summarize(
    mean_rate = mean(healing_rate, na.rm = TRUE),
    sd_rate = sd(healing_rate, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

cat("\n=== Healing Rate by Fish × Wound ===\n")
print(rate_avg_interaction)
```

---

# 7. Model Diagnostics

## DHARMa Residual Diagnostics

```{r dharma-diagnostics, fig.width=10, fig.height=7}
library(DHARMa)

# Simulate residuals for full model
sim_rate_full <- simulateResiduals(fittedModel = rate_full, n = 1000)

# Save DHARMa diagnostic plot
png(
  here("figures", "diagnostics", "sim_rate_full.png"),
  width = 7, height = 6, units = "in", res = 600, bg = "white"
)
plot(sim_rate_full, main = "DHARMa Diagnostics: Full Model")
dev.off()

# Statistical tests
cat("\n=== Dispersion Test ===\n")
print(testDispersion(sim_rate_full))

cat("\n=== Zero-Inflation Test ===\n")
print(testZeroInflation(sim_rate_full))
```

## Diagnostics for All Candidate Models

```{r all-model-diagnostics}
model_list <- list(
  Full = rate_full,
  NoInteraction = rate_no_interaction,
  NoFish = rate_no_fish,
  NoWound = rate_no_wound
)

for (nm in names(model_list)) {
  cat("\n========== Diagnostics for", nm, "model ==========\n")
  sim <- simulateResiduals(model_list[[nm]], n = 1000)

  # Save DHARMa plot
  png(
    here("figures", "diagnostics", paste0("resid_", nm, ".png")),
    width = 7, height = 6, units = "in", res = 600, bg = "white"
  )
  plot(sim, main = paste("DHARMa Diagnostics:", nm, "Model"))
  dev.off()

  # Print test results
  cat("\n  Dispersion test:\n")
  print(testDispersion(sim))
  cat("\n  Outlier test:\n")
  print(testOutliers(sim))
}

cat("\n✓ All diagnostic plots saved to figures/diagnostics/\n")
```

## Predicted vs Observed

```{r pred-vs-obs, fig.width=10, fig.height=8}
# Add predictions to data
percent_closure$pred_full <- predict(rate_full)

# Create scatterplot
p_fit <- ggplot(percent_closure, aes(x = pred_full, y = healing_rate)) +
  geom_point(color = "steelblue", size = 2, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "darkred") +
  labs(
    x = "Predicted Healing Rate",
    y = "Observed Healing Rate",
    title = "Model Fit Check: rate_full"
  ) +
  theme_bw(base_size = 14)

print(p_fit)

ggsave(
  here("figures", "diagnostics", "fit_scatterplot.png"),
  p_fit,
  width = 10, height = 8, dpi = 300, bg = "white"
)
```

## Residual Diagnostic Panel

```{r residual-panel, fig.width=14, fig.height=7}
library(patchwork)

# Residuals vs index
p_resid_plot <- ggplot(
  data.frame(resid = residuals(rate_full, type = "pearson")),
  aes(x = seq_along(resid), y = resid)
) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(title = "Pearson Residuals", x = "Observation", y = "Residual")

# Residuals vs fitted
p_fit_plot <- ggplot(
  data.frame(fitted = fitted(rate_full),
             resid = residuals(rate_full, type = "pearson")),
  aes(x = fitted, y = resid)
) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme_minimal() +
  labs(title = "Residuals vs Fitted", x = "Fitted values", y = "Residuals")

# Combine panels
p_resid_panel <- (p_resid_plot | p_fit_plot) +
  plot_annotation(
    title = "Residual Diagnostics for Healing Rate Models",
    theme = theme(plot.title = element_text(size = 18, face = "bold"))
  )

print(p_resid_panel)

# Save panel
ggsave(
  here("figures","diagnostics","healing_rate_diagnostics_panel.png"),
  p_resid_panel,
  width = 14, height = 7, dpi = 300, bg = "white"
)
```

## QQ-Plot for Normality

```{r qq-plot, fig.width=8, fig.height=8}
p_qq <- ggplot(
  data.frame(resid = residuals(rate_full, type = "pearson")),
  aes(sample = resid)
) +
  stat_qq(color = "steelblue", size = 2) +
  stat_qq_line(color = "darkred", linewidth = 1) +
  theme_bw(base_size = 14) +
  labs(
    title = "Normal Q-Q Plot of Residuals",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  )

print(p_qq)

ggsave(
  here("figures", "diagnostics", "qq_plot_residuals.png"),
  p_qq,
  width = 8, height = 8, dpi = 300, bg = "white"
)
```

## Scale-Location Plot

```{r scale-location, fig.width=10, fig.height=7}
p_scale_loc <- ggplot(
  data.frame(
    fitted = fitted(rate_full),
    sqrt_abs_resid = sqrt(abs(residuals(rate_full, type = "pearson")))
  ),
  aes(x = fitted, y = sqrt_abs_resid)
) +
  geom_point(alpha = 0.6, color = "steelblue", size = 2) +
  geom_smooth(se = TRUE, color = "darkred", method = "loess") +
  theme_bw(base_size = 14) +
  labs(
    title = "Scale-Location Plot",
    x = "Fitted Values",
    y = expression(sqrt("|Standardized Residuals|"))
  )

print(p_scale_loc)

ggsave(
  here("figures", "diagnostics", "scale_location_plot.png"),
  p_scale_loc,
  width = 10, height = 7, dpi = 300, bg = "white"
)
```

## Diagnostic Summary Statistics

```{r diagnostic-summary}
cat("\n=== Model Diagnostics Summary ===\n")
cat("\nResidual standard deviation:", sigma(rate_full), "\n")
cat("Number of observations:", nobs(rate_full), "\n")
cat("\nResidual summary statistics:\n")
print(summary(residuals(rate_full, type = "pearson")))

# Check for influential observations
cat("\n\n=== Checking for Influential Observations ===\n")
influence_measures <- influence(rate_full, obs = TRUE)
cat("Cook's distance threshold (4/n):", 4/nobs(rate_full), "\n")
```

---

# 8. Session Information

```{r session-info}
sessionInfo()
```

---

**Analysis Complete** ✓

All figures and tables saved to `figures/` directory.
