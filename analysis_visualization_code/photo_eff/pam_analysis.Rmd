---
title: "Coral Photosynthetic Efficiency: PAM Fluorometry Analysis"
author: "Hayden Vega & Adrian Stier"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    theme: flatly
    highlight: tango
    df_print: paged
description: |
  Analysis of pulse-amplitude modulated (PAM) fluorometry data from the damselfish-coral healing experiment.
  This document examines how fish presence and wound size affect coral photosynthetic efficiency (Fv/Fm).
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.retina = 2
)
```

# Overview {.tabset}

## Study Context

**Experiment**: Damselfish effects on coral wound healing in Mo'orea, French Polynesia

**Measurements**: Pulse-amplitude modulated (PAM) fluorometry to assess coral photosynthetic health

**Design**:
- **Treatments**: 2 × 3 factorial (Fish Presence × Wound Size)
  - Fish: Present vs. Absent
  - Wound: No Wound, Small, Large
- **Replication**: 72 coral fragments across 12 tanks
- **Duration**: 21-day experiment

**Key Metric**: **Fv/Fm** (Variable fluorescence / Maximum fluorescence)
- Standard measure of photosystem II efficiency
- Healthy corals typically show Fv/Fm > 0.6
- Lower values indicate photosynthetic stress

## Analysis Roadmap

```{r roadmap, echo=FALSE, results='asis'}
cat("
### Analysis Pipeline

**1. Data Preparation** ✓
- Import PAM fluorometry data
- Factor level ordering
- Data validation

**2. Main Effects Analysis** ✓
- Mixed-effects models (tank as random effect)
- Fish presence effects on Fv/Fm
- Wound size effects on Fv/Fm
- Fish × Wound interaction

**3. Algae Colonization Analysis** ✓
- Test if algal colonization affects Fv/Fm
- Account for confounding with fish treatments

**4. Publication Figure** ✓
- Mean ± SD by treatment
- Professional formatting
- Dual format output (PDF + PNG)

**5. Model Diagnostics** ✓
- DHARMa simulated residuals
- QQ plots and residual patterns
- Model validation
")
```

# {-}

---

# 1. Setup & Data Import

## Load Required Packages

```{r load-packages}
#------------------------------------------------------------------------------#
# Package Loading
#------------------------------------------------------------------------------#

# Data manipulation
library(tidyverse)    # Modern data science toolkit
library(janitor)      # Clean column names
library(here)         # Project-relative paths

# Statistical modeling
library(lme4)         # Linear mixed-effects models
library(DHARMa)       # Model diagnostics via simulation
library(MuMIn)        # Model selection (AIC, R²)
library(parameters)   # Extract model parameters
library(effects)      # Effect plots
library(broom.mixed)  # Tidy model outputs

# Visualization
library(ggplot2)      # Grammar of graphics
library(viridis)      # Color-blind friendly palettes
library(ggeffects)    # Model-based predictions
library(sjlabelled)   # Variable labels
library(ggpubr)       # Publication-ready plots
library(gt)           # Publication tables

cat("✓ All packages loaded successfully\n")
```

## Import PAM Data

```{r import-data}
#------------------------------------------------------------------------------#
# Data Import
#------------------------------------------------------------------------------#
# Three datasets with different tissue sampling strategies:
# 1. pam_healed: Only healed tissue from wounded corals
# 2. pam_undisturbed_tissue_wound_no_wound: Undisturbed tissue from all corals
# 3. pam_undisturbed_healed_tissue_wound_no_wound: Comprehensive dataset

pam_healed <- read.csv(here("data", "pam_healed.csv"))

pam_undisturbed_tissue_wound_no_wound <- read.csv(
  here("data", "pam_undisturbed_healed.csv")
)

pam_undisturbed_healed_tissue_wound_no_wound <- read.csv(
  here("data", "pam_undisturbed_healed_tissue_wound_no_wound.csv")
)

cat("✓ PAM data imported successfully\n")
cat("  - pam_healed:", nrow(pam_healed), "observations\n")
cat("  - pam_undisturbed_healed_tissue_wound_no_wound:",
    nrow(pam_undisturbed_healed_tissue_wound_no_wound), "observations\n")
```

## Define Visual Aesthetics

```{r define-aesthetics}
#------------------------------------------------------------------------------#
# Color Palettes and Factor Ordering
#------------------------------------------------------------------------------#
# Consistent color scheme across all figures

# Wound size palette (warm tones)
wound_palette <- c(
  "Large" = "#ffbf00",      # Amber
  "Small" = "#be8333",      # Bronze
  "No Wound" = "#f57a38"    # Coral orange
)

# Fish presence palette (cool vs. warm contrast)
fish_palette <- c(
  "Fish" = "#2b4b52",       # Deep teal (cool = fish present)
  "No Fish" = "#ad301a"     # Brick red (warm = fish absent)
)

# Set factor level ordering for consistent plotting
# Order: No Wound → Small → Large (increasing disturbance)
pam_undisturbed_healed_tissue_wound_no_wound <- pam_undisturbed_healed_tissue_wound_no_wound %>%
  mutate(
    fish = factor(fish, levels = c("No Fish", "Fish")),
    wound = factor(wound, levels = c("No Wound", "Small", "Large"))
  )

pam_healed <- pam_healed %>%
  mutate(
    wound = factor(wound, levels = c("Small", "Large")),
    fish = factor(fish, levels = c("No Fish", "Fish"))
  )

cat("✓ Visual aesthetics configured\n")
cat("  - Factor levels ordered: No Wound → Small → Large\n")
cat("  - Fish levels ordered: No Fish → Fish\n")
```

---

# 2. Main Effects: Fish and Wound Impacts on Fv/Fm

## Research Questions

1. Does fish presence affect coral photosynthetic efficiency?
2. Does wound size affect photosynthetic efficiency?
3. Is there an interaction between fish and wound treatments?

## Fit Mixed-Effects Models

```{r fit-fvfm-models}
#------------------------------------------------------------------------------#
# Mixed-Effects Models for Fv/Fm
#------------------------------------------------------------------------------#
# Model structure: fv_fm ~ fixed effects + (1 | tank)
# Random intercept for tank accounts for within-tank correlation

# Full model with interaction
rate_full_no_wound <- lmer(
  fv_fm ~ fish * wound + (1 | tank),
  data = pam_undisturbed_healed_tissue_wound_no_wound
)

# Additive model (no interaction)
rate_no_interaction_no_wound <- lmer(
  fv_fm ~ fish + wound + (1 | tank),
  data = pam_undisturbed_healed_tissue_wound_no_wound
)

# Fish-only model
rate_no_fish_no_wound <- lmer(
  fv_fm ~ wound + (1 | tank),
  data = pam_undisturbed_healed_tissue_wound_no_wound
)

# Wound-only model
rate_no_wound_no_wound <- lmer(
  fv_fm ~ fish + (1 | tank),
  data = pam_undisturbed_healed_tissue_wound_no_wound
)

cat("✓ Four models fitted successfully\n")
```

## Likelihood Ratio Tests

```{r lrt-fvfm}
#------------------------------------------------------------------------------#
# Likelihood Ratio Tests (LRTs)
#------------------------------------------------------------------------------#
# Compare nested models to test significance of each effect

# Test interaction term
lrt_interaction_zero_rate_no_wound <- anova(
  rate_no_interaction_no_wound,
  rate_full_no_wound,
  test = "Chisq"
)

# Test fish effect
lrt_fish_zero_rate_no_wound <- anova(
  rate_no_fish_no_wound,
  rate_no_interaction_no_wound,
  test = "Chisq"
)

# Test wound effect
lrt_wound_zero_rate_no_wound <- anova(
  rate_no_wound_no_wound,
  rate_no_interaction_no_wound,
  test = "Chisq"
)

# Compile results into tidy table
lrt_table_fv_fm_all <- tibble(
  Test = c("Interaction (Fish × Wound)", "Fish Effect", "Wound Effect"),
  ChiSq = c(
    lrt_interaction_zero_rate_no_wound$Chisq[2],
    lrt_fish_zero_rate_no_wound$Chisq[2],
    lrt_wound_zero_rate_no_wound$Chisq[2]
  ),
  Df = c(
    lrt_interaction_zero_rate_no_wound$Df[2],
    lrt_fish_zero_rate_no_wound$Df[2],
    lrt_wound_zero_rate_no_wound$Df[2]
  ),
  p_value = c(
    lrt_interaction_zero_rate_no_wound$`Pr(>Chisq)`[2],
    lrt_fish_zero_rate_no_wound$`Pr(>Chisq)`[2],
    lrt_wound_zero_rate_no_wound$`Pr(>Chisq)`[2]
  )
) %>%
  mutate(across(where(is.numeric), round, 3))

cat("✓ Likelihood ratio tests completed\n")
```

## Publication Table: LRT Results

```{r lrt-table-publication}
#------------------------------------------------------------------------------#
# Format LRT Table for Publication
#------------------------------------------------------------------------------#

lrt_table_fv_fm_all %>%
  gt() %>%
  tab_header(
    title = "Table. Likelihood Ratio Tests for Effects on Fv/Fm",
    subtitle = "Mixed-effects models with tank as random effect"
  ) %>%
  cols_label(
    Test = "Model Comparison",
    ChiSq = "χ²",
    Df = "df",
    p_value = "P-value"
  ) %>%
  fmt_number(columns = c(ChiSq, p_value), decimals = 3) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = p_value,
      rows = p_value < 0.05
    )
  ) %>%
  tab_options(
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 13
  )
```

## Summary Statistics by Treatment

```{r summary-stats-fvfm}
#------------------------------------------------------------------------------#
# Calculate Mean ± SD for Each Treatment Group
#------------------------------------------------------------------------------#

# By wound size
fv_fm_avg_wound <- pam_undisturbed_healed_tissue_wound_no_wound %>%
  group_by(wound) %>%
  summarize(
    mean_fv_fm = mean(fv_fm, na.rm = TRUE),
    sd_fv_fm = sd(fv_fm, na.rm = TRUE),
    n = n()
  )

cat("Fv/Fm by Wound Size:\n")
print(fv_fm_avg_wound)
# No Wound: 684.7 ± 11.64
# Small:    665.5 ± 36.43
# Large:    658.7 ± 36.86

# By fish presence
fv_fm_avg_fish <- pam_undisturbed_healed_tissue_wound_no_wound %>%
  group_by(fish) %>%
  summarize(
    mean_fv_fm = mean(fv_fm, na.rm = TRUE),
    sd_fv_fm = sd(fv_fm, na.rm = TRUE),
    n = n()
  )

cat("\nFv/Fm by Fish Presence:\n")
print(fv_fm_avg_fish)
# No Fish: 657.9 ± 38.41
# Fish:    681.4 ± 15.53

# By interaction (fish × wound)
pam_avg_interaction <- pam_undisturbed_healed_tissue_wound_no_wound %>%
  group_by(fish, wound) %>%
  summarize(
    mean_fv_fm = mean(fv_fm, na.rm = TRUE),
    sd_fv_fm = sd(fv_fm, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  )

cat("\nFv/Fm by Fish × Wound Interaction:\n")
print(pam_avg_interaction)
# No Fish, No Wound: 683.6 ± 12.06
# No Fish, Small:    657.0 ± 43.46
# No Fish, Large:    633.1 ± 35.68
# Fish, No Wound:    685.9 ± 11.63
# Fish, Small:       674.0 ± 27.00
# Fish, Large:       684.4 ± 11.62
```

---

# 3. Algae Colonization Effects

## Background

Some coral fragments developed algal colonization during the experiment. We need to test whether algae presence confounds our fish and wound effects on photosynthetic efficiency.

## Visualize Algae Distribution

```{r visualize-algae}
#------------------------------------------------------------------------------#
# Exploratory Plots: Algae Effects on Fv/Fm
#------------------------------------------------------------------------------#

# Algae × Fish interaction
p_algae_fish <- ggplot(pam_healed, aes(x = algae, y = fv_fm, fill = fish)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 2) +
  scale_fill_manual(values = fish_palette) +
  labs(
    x = "Algae Presence",
    y = "Fv/Fm",
    title = "Photosynthetic Efficiency by Algae and Fish",
    fill = "Fish Presence"
  ) +
  theme_minimal(base_size = 14)

print(p_algae_fish)

# Algae × Wound interaction
p_algae_wound <- ggplot(pam_healed, aes(x = algae, y = fv_fm, fill = wound)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 2) +
  scale_fill_manual(values = wound_palette) +
  labs(
    x = "Algae Presence",
    y = "Fv/Fm",
    title = "Photosynthetic Efficiency by Algae and Wound Size",
    fill = "Wound Size"
  ) +
  theme_minimal(base_size = 14)

print(p_algae_wound)

cat("✓ Algae exploratory plots generated\n")
cat("  - Note: Only 8 corals had algae (7 No Fish, 1 Fish)\n")
cat("  - Algae presence confounded with fish treatment\n")
```

## Test Algae Effect with Models

```{r test-algae-effect}
#------------------------------------------------------------------------------#
# Mixed-Effects Models Including Algae
#------------------------------------------------------------------------------#

# Full model with 3-way interaction
mod_int_algae <- lmer(
  fv_fm ~ fish * wound * algae + (1 | tank),
  data = pam_healed
)

# Additive model without algae interactions
mod_add_algae <- lmer(
  fv_fm ~ fish * wound + algae + (1 | tank),
  data = pam_healed
)

# Algae-only model
mod_algae <- lmer(
  fv_fm ~ algae + (1 | tank),
  data = pam_healed
)

# LRT: Does algae improve model fit?
lrt_algae <- anova(mod_algae, mod_add_algae, test = "Chisq")

cat("✓ Algae models fitted\n")
cat("  - LRT p-value for algae effect:", round(lrt_algae$`Pr(>Chisq)`[2], 3), "\n")
cat("  - Conclusion: NO significant effect of algae (p = 0.106)\n")
```

---

# 4. Publication Figure: Fv/Fm by Treatment

## Main Figure with Error Bars

```{r publication-figure-fvfm, fig.width=8, fig.height=6}
#------------------------------------------------------------------------------#
# Publication-Quality Figure: Fv/Fm by Fish and Wound
#------------------------------------------------------------------------------#
# Mean ± SD with jittered raw data
# Dodged by fish presence

pam_line_plot_fish <- pam_undisturbed_healed_tissue_wound_no_wound %>%
  ggplot(aes(x = wound, y = fv_fm, color = fish, group = fish, shape = fish)) +

  # Raw data (jittered and dodged)
  geom_jitter(
    alpha = 0.25,
    size = 2.5,
    position = position_jitterdodge(
      jitter.width = 0.1,
      dodge.width = 0.6
    )
  ) +

  # Mean points (dodged)
  stat_summary(
    fun = mean,
    geom = "point",
    size = 5,
    position = position_dodge(width = 0.6)
  ) +

  # Error bars: Mean ± SD (dodged, no caps)
  stat_summary(
    fun.data = function(x) {
      data.frame(
        y = mean(x),
        ymin = mean(x) - sd(x),
        ymax = mean(x) + sd(x)
      )
    },
    geom = "errorbar",
    width = 0,
    size = 1,
    position = position_dodge(width = 0.6)
  ) +

  # Color and shape scales
  scale_color_manual(
    values = fish_palette,
    name = "Fish Presence",
    labels = c("No Fish", "Fish")
  ) +
  scale_shape_manual(
    values = c(16, 18),
    name = "Fish Presence",
    labels = c("No Fish", "Fish")
  ) +

  # Y-axis limits
  scale_y_continuous(limits = c(500, 800)) +

  # Labels and theme
  labs(
    y = "Photosynthetic Efficiency (Fv/Fm)",
    x = "Wound Size"
  ) +
  theme_minimal(base_size = 16) +
  theme(
    panel.grid = element_blank(),
    axis.title = element_text(size = 20, face = "bold"),
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 16),
    legend.position = "top",
    legend.title = element_text(size = 18, face = "bold"),
    legend.text = element_text(size = 16),
    legend.key.size = unit(1.5, "lines"),
    legend.margin = margin(0, 0, 10, 0),
    legend.box.spacing = unit(0.5, "lines"),
    axis.line.x = element_line(color = "black", size = 0.5),
    axis.line.y = element_line(color = "black", size = 0.5)
  )

print(pam_line_plot_fish)

cat("✓ Publication figure generated\n")
```

## Save Publication Figure

```{r save-pam-figure}
#------------------------------------------------------------------------------#
# Export Publication Figure (Dual Format)
#------------------------------------------------------------------------------#

# PDF - vector format for print/journal submission
ggsave(
  filename = here("figures", "pam", "summary_line_fv_fm_by_wound_fish.pdf"),
  plot = pam_line_plot_fish,
  width = 7,
  height = 5,
  dpi = 600,
  device = cairo_pdf
)

# PNG - raster format for presentations/web
ggsave(
  filename = here("figures", "pam", "summary_line_fv_fm_by_wound_fish.png"),
  plot = pam_line_plot_fish,
  width = 8,
  height = 6,
  dpi = 300,
  bg = "white"
)

cat("✓ Figure saved in dual format:\n")
cat("  - PDF: figures/pam/summary_line_fv_fm_by_wound_fish.pdf (600 DPI)\n")
cat("  - PNG: figures/pam/summary_line_fv_fm_by_wound_fish.png (300 DPI)\n")
```

---

# 5. Model Diagnostics

## DHARMa Simulated Residuals

```{r dharma-diagnostics}
#------------------------------------------------------------------------------#
# DHARMa Diagnostics for Full PAM Model
#------------------------------------------------------------------------------#
# Simulate residuals to check model assumptions

cat("=== Diagnostics for PAM Fv/Fm Full Model ===\n\n")

# Simulate 1000 datasets from fitted model
sim_pam_full <- simulateResiduals(fittedModel = rate_full_no_wound, n = 1000)

# Save DHARMa diagnostic plot
png(
  here("figures", "diagnostics", "pam_dharma_full.png"),
  width = 7, height = 6, units = "in", res = 600, bg = "white"
)
plot(sim_pam_full, main = "DHARMa Diagnostics: PAM Full Model (Fv/Fm)")
dev.off()

cat("\nDispersion test:\n")
print(testDispersion(sim_pam_full))

cat("\nOutlier test:\n")
print(testOutliers(sim_pam_full))

cat("\n✓ DHARMa diagnostics saved to figures/diagnostics/pam_dharma_full.png\n")
```

## Predicted vs Observed

```{r predicted-observed}
#------------------------------------------------------------------------------#
# Predicted vs Observed Values
#------------------------------------------------------------------------------#

# Add predictions to dataset
pam_undisturbed_healed_tissue_wound_no_wound$pred_fvfm <- predict(rate_full_no_wound)

p_pam_fit <- ggplot(
  pam_undisturbed_healed_tissue_wound_no_wound,
  aes(x = pred_fvfm, y = fv_fm)
) +
  geom_point(aes(color = fish), size = 2.5, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", linewidth = 1) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = fish_palette) +
  labs(
    x = "Predicted Fv/Fm",
    y = "Observed Fv/Fm",
    title = "PAM Model Fit: Predicted vs Observed",
    color = "Fish Presence"
  ) +
  theme_bw(base_size = 14) +
  theme(legend.position = "top")

print(p_pam_fit)

ggsave(
  here("figures", "diagnostics", "pam_fit_scatterplot.png"),
  p_pam_fit,
  width = 10, height = 8, dpi = 300, bg = "white"
)

cat("✓ Predicted vs Observed plot saved\n")
```

## Residual Diagnostics

```{r residual-diagnostics}
#------------------------------------------------------------------------------#
# Residual vs Fitted Values
#------------------------------------------------------------------------------#

p_pam_resid <- ggplot(
  data.frame(
    fitted = fitted(rate_full_no_wound),
    resid = residuals(rate_full_no_wound, type = "pearson")
  ),
  aes(x = fitted, y = resid)
) +
  geom_point(alpha = 0.6, color = "steelblue", size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkred") +
  geom_smooth(se = TRUE, color = "darkgreen", method = "loess") +
  theme_bw(base_size = 14) +
  labs(
    title = "Residuals vs Fitted Values (PAM)",
    x = "Fitted Fv/Fm Values",
    y = "Pearson Residuals"
  )

print(p_pam_resid)

ggsave(
  here("figures", "diagnostics", "pam_residuals_vs_fitted.png"),
  p_pam_resid,
  width = 10, height = 7, dpi = 300, bg = "white"
)

cat("✓ Residual diagnostic plot saved\n")
```

## QQ Plot

```{r qq-plot}
#------------------------------------------------------------------------------#
# Normal Q-Q Plot for Residuals
#------------------------------------------------------------------------------#

p_pam_qq <- ggplot(
  data.frame(resid = residuals(rate_full_no_wound, type = "pearson")),
  aes(sample = resid)
) +
  stat_qq(color = "steelblue", size = 2) +
  stat_qq_line(color = "darkred", linewidth = 1) +
  theme_bw(base_size = 14) +
  labs(
    title = "Normal Q-Q Plot: PAM Model Residuals",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  )

print(p_pam_qq)

ggsave(
  here("figures", "diagnostics", "pam_qq_plot.png"),
  p_pam_qq,
  width = 8, height = 8, dpi = 300, bg = "white"
)

cat("✓ QQ plot saved\n")
```

## Model Summary Statistics

```{r model-summary}
#------------------------------------------------------------------------------#
# Model Summary Statistics
#------------------------------------------------------------------------------#

cat("\n=== PAM Model Diagnostics Summary ===\n")
cat("Residual standard deviation:", sigma(rate_full_no_wound), "\n")
cat("Number of observations:", nobs(rate_full_no_wound), "\n")
cat("\nResidual summary:\n")
print(summary(residuals(rate_full_no_wound, type = "pearson")))

cat("\n✓ All diagnostic plots saved to figures/diagnostics/\n")
```

---

# 6. Session Information

```{r session-info}
#------------------------------------------------------------------------------#
# Document R Session for Reproducibility
#------------------------------------------------------------------------------#

sessionInfo()
```

---

**Analysis completed:** `r Sys.time()`

**Key Findings:**
- Fish presence significantly affects coral photosynthetic efficiency (Fv/Fm)
- Wound size shows measurable effects on photosynthetic performance
- No significant fish × wound interaction detected
- Algal colonization did not significantly confound results (p = 0.106)
- Model diagnostics indicate good fit with no major assumption violations
